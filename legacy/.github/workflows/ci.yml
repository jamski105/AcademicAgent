# GitHub Actions CI/CD Workflow für AcademicAgent
# Führt automatisierte Tests, Linting und Security-Checks aus

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ============================================
  # Job 1: Setup & Installation-Tests
  # ============================================
  setup-test:
    name: Setup & Installations-Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Installiere System-Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            poppler-utils \
            jq \
            chromium-browser \
            curl \
            wget

      - name: Installiere Python-Packages
        run: |
          pip install --upgrade pip
          pip install -r tests/requirements-test.txt

      - name: Installiere Node-Packages
        run: |
          npm install playwright

      - name: Verifiziere Installationen
        run: |
          echo "=== Verifiziere Tools ==="
          pdftotext -v || echo "pdftotext nicht verfügbar"
          jq --version
          python3 --version
          node --version
          npm --version
          echo "✅ Setup-Test erfolgreich"

  # ============================================
  # Job 2: Unit-Tests
  # ============================================
  unit-tests:
    name: Unit-Tests
    runs-on: ubuntu-latest
    needs: setup-test

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Installiere Test-Dependencies
        run: |
          pip install --upgrade pip
          pip install -r tests/requirements-test.txt

      - name: Führe Unit-Tests aus
        run: |
          echo "=== Führe Unit-Tests aus ==="
          python3 -m pytest tests/unit/ -v --cov=scripts --cov-report=xml --cov-report=term

      - name: Upload Coverage zu Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # ============================================
  # Job 3: Security & Red-Team-Tests
  # ============================================
  security-tests:
    name: Security & Red-Team-Tests
    runs-on: ubuntu-latest
    needs: setup-test

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Installiere Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Führe Red-Team-Tests aus
        run: |
          echo "=== Führe Red-Team Security-Tests aus ==="
          bash tests/red_team/run_tests.sh

      - name: Prüfe Pass-Rate
        run: |
          PASS_RATE=$(jq -r '.pass_rate' tests/red_team/test_results.json)
          echo "Pass-Rate: $PASS_RATE%"

          if (( $(echo "$PASS_RATE < 90" | bc -l) )); then
            echo "❌ Pass-Rate unter 90% ($PASS_RATE%)"
            exit 1
          else
            echo "✅ Pass-Rate OK: $PASS_RATE%"
          fi

  # ============================================
  # Job 4: Script-Validierung
  # ============================================
  script-validation:
    name: Script-Validierung
    runs-on: ubuntu-latest
    needs: setup-test

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Syntax-Check Python-Scripts
        run: |
          echo "=== Prüfe Python-Syntax ==="
          find scripts/ -name "*.py" -exec python3 -m py_compile {} \;
          echo "✅ Alle Python-Scripts syntaktisch korrekt"

      - name: Syntax-Check Bash-Scripts
        run: |
          echo "=== Prüfe Bash-Syntax ==="
          find scripts/ -name "*.sh" -exec bash -n {} \;
          echo "✅ Alle Bash-Scripts syntaktisch korrekt"

      - name: Teste kritische Scripts
        run: |
          echo "=== Teste kritische Scripts ==="

          # Test action_gate.py
          python3 scripts/action_gate.py validate \
            --action bash \
            --command "python3 scripts/test.py" \
            --source system

          # Test validate_domain.py
          python3 scripts/validate_domain.py "https://ieeexplore.ieee.org" || true

          # Test retry_strategy.py
          python3 scripts/retry_strategy.py

          echo "✅ Script-Tests erfolgreich"

  # ============================================
  # Job 5: Secrets-Scanning
  # ============================================
  secrets-scan:
    name: Secrets-Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Alle Commits für Secret-Scan

      - name: Führe Secret-Scan aus
        run: |
          echo "=== Scanne nach Secrets ==="

          # Einfacher Grep-basierter Scan
          echo "Prüfe auf API-Keys..."
          if grep -r -E 'ANTHROPIC_API_KEY[[:space:]]*=[[:space:]]*sk-ant-' . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=.github; then
            echo "❌ Potentieller API-Key gefunden!"
            exit 1
          fi

          echo "Prüfe auf .env Dateien..."
          if find . -name ".env" -not -path "./.git/*" -not -path "./node_modules/*" | grep -q .; then
            echo "❌ .env Datei gefunden!"
            exit 1
          fi

          echo "✅ Keine Secrets gefunden"

  # ============================================
  # Job 6: Build-Validierung
  # ============================================
  build-validation:
    name: Build-Validierung
    runs-on: ubuntu-latest
    needs: [unit-tests, security-tests, script-validation]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          echo "=== Validiere Build ==="

          # Prüfe ob alle kritischen Dateien existieren
          test -f setup.sh || { echo "setup.sh fehlt"; exit 1; }
          test -f README.md || { echo "README.md fehlt"; exit 1; }
          test -f SECURITY.md || { echo "SECURITY.md fehlt"; exit 1; }
          test -d scripts/ || { echo "scripts/ fehlt"; exit 1; }
          test -d .claude/ || { echo ".claude/ fehlt"; exit 1; }

          echo "✅ Build-Struktur OK"

      - name: Validiere Agent-Konfigurationen
        run: |
          echo "=== Validiere Agent-Configs ==="

          # Prüfe ob alle Agents existieren
          test -f .claude/agents/browser-agent.md || exit 1
          test -f .claude/agents/search-agent.md || exit 1
          test -f .claude/agents/extraction-agent.md || exit 1
          test -f .claude/agents/scoring-agent.md || exit 1
          test -f .claude/agents/setup-agent.md || exit 1

          echo "✅ Alle Agent-Configs vorhanden"

  # ============================================
  # Job 7: E2E Pipeline-Tests
  # ============================================
  e2e-tests:
    name: E2E Pipeline-Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, security-tests, script-validation, build-validation]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Installiere Test-Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install --upgrade pip

      - name: Führe E2E Pipeline-Test aus
        run: |
          echo "=== Führe E2E Pipeline-Test aus ==="
          bash tests/e2e/test_minimal_pipeline.sh

      - name: Validiere Test-Output
        run: |
          echo "✅ E2E Pipeline-Test erfolgreich"

  # ============================================
  # Job 8: Status-Report
  # ============================================
  status-report:
    name: CI Status-Report
    runs-on: ubuntu-latest
    needs: [unit-tests, security-tests, script-validation, build-validation, e2e-tests]
    if: always()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Erstelle Status-Report
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ CI/CD WORKFLOW ABGESCHLOSSEN"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo "Autor: ${{ github.actor }}"
          echo ""
          echo "Alle Tests erfolgreich!"

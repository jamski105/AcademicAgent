# DBIS HTML Selectors Configuration
# Academic Agent v2.3 - Auto-Discovery
#
# These selectors are used by dbis_search agent to scrape database lists
# from DBIS discipline pages.
#
# ✅ TESTED: 2026-02-27 - Selectors validated against live DBIS pages
# Test URL: https://dbis.ur.de/UBTIB/browse/subjects/9/

---

# ========================================
# DATABASE ENTRY SELECTORS
# ========================================

database_entry:
  # Primary selector for database list items
  # DBIS uses links with /resources/ in href for database entries
  primary: "a[href*='/resources/']"

  # Fallback selectors (try in order)
  fallbacks:
    - "a[href*='resources']"
    - "span.tag a"
    - "tr[id^='db_']"  # Old table-based structure (deprecated)
    - ".db-entry"

# ========================================
# DATABASE METADATA SELECTORS
# ========================================

database_name:
  # Selector for database name/title
  # Same as database_entry (the link text contains the name)
  primary: "a[href*='/resources/']"

  fallbacks:
    - "a[href*='resources']"
    - "td.td2 a"  # Old structure (deprecated)
    - ".db-name"
    - "h3"

database_link:
  # Selector for "Zur Datenbank" link (activates TIB license!)
  primary: "a[title='Zum Angebot']"

  fallbacks:
    - "a:contains('Zur Datenbank')"
    - ".db-link"
    - "a[href*='erf=']"  # DBIS redirect URL pattern

# ========================================
# TRAFFIC LIGHT (ACCESS STATUS) SELECTORS
# ========================================

traffic_light:
  # Image selector for access status icon
  # DBIS now uses SVG files for traffic lights
  primary: "img.traffic-light"

  fallbacks:
    - "img[src*='ampel']"
    - "span.traffic-light-container img"
    - "img[src*='dbis_']"  # Old structure (deprecated)
    - ".access-status img"

  # Traffic light color patterns (in image src)
  green:
    - "ampel_green"   # Free access (grün)
    - "dbis_gr_"      # Old format
    - "amp_gruen"
    - "green"
    - "frei"

  yellow:
    - "ampel_yellow"  # TIB license (gelb)
    - "dbis_ge_"      # Old format
    - "amp_gelb"
    - "yellow"
    - "lizenziert"

  red:
    - "ampel_red"     # No access (rot)
    - "dbis_ro_"      # Old format
    - "amp_rot"
    - "red"
    - "nzg"           # "Nicht zugänglich"

# ========================================
# PAGINATION SELECTORS
# ========================================

pagination:
  next_page: "a:contains('nächste')"
  page_numbers: ".page-numbers a"
  current_page: ".page-numbers .current"

# ========================================
# ERROR DETECTION
# ========================================

error_indicators:
  no_results:
    - "text:Keine Datenbanken gefunden"
    - ".no-results"
    - "#error-message"

  page_load_failed:
    - "text:Fehler beim Laden"
    - "text:Error"
    - ".error-page"

# ========================================
# EXTRACTION PATTERNS
# ========================================

# Regex patterns for extracting info from text
patterns:
  # Extract database ID from link href
  # Example: href="erf=123&colors=15" → db_id=123
  database_id: 'erf=(\d+)'

  # Extract TIB institution ID
  institution_id: 'bib_id=(\w+)'

# ========================================
# TESTING URLS
# ========================================

test_urls:
  # NEW URL STRUCTURE (2026+)
  bibliothekswesen: "https://dbis.ur.de/UBTIB/browse/subjects/9/"
  rechtswissenschaft: "https://dbis.ur.de/UBTIB/browse/subjects/9.1/"
  medizin: "https://dbis.ur.de/UBTIB/browse/subjects/7/"
  informatik: "https://dbis.ur.de/UBTIB/browse/subjects/11/"

  # OLD URLs (deprecated - may return 404)
  # rechtswissenschaft_old: "https://dbis.ur.de/dbis/dbliste.php?bib_id=ubtib&colors=15&lett=f&sGeb=9.1"
  # medizin_old: "https://dbis.ur.de/dbis/dbliste.php?bib_id=ubtib&colors=15&lett=f&sGeb=7"

# ========================================
# NOTES
# ========================================

# How to test these selectors:
# 1. Open one of the test_urls in a browser
# 2. Open browser DevTools (F12)
# 3. Use Console to test selectors:
#    document.querySelectorAll("a[href*='/resources/']")
# 4. Verify correct elements are selected
# 5. Update selectors if needed

# DBIS page structure (NEW - 2026):
# Modern SPA with React/Vue components:
# <span class="tag is-medium m-1 has-text-link">
#   <a href="/UBTIB/resources/104296">
#     <span class="traffic-light-container">
#       <img class="traffic-light" src="/img/icons/ampel_green.svg" alt="">
#     </span>
#     <span>Database Name Here</span>
#   </a>
# </span>

# OLD page structure (DEPRECATED - pre-2026):
# <table id="dbliste">
#   <tr id="db_123" class="even">
#     <td class="td1"><img src="dbis_ge_01.gif" alt="lizenziert"></td>
#     <td class="td2">
#       <a href="erf=123&colors=15">Beck-Online</a>
#       <br><a title="Zum Angebot" href="...">Zur Datenbank</a>
#     </td>
#     <td class="td3">Description...</td>
#   </tr>
# </table>

# VALIDATION RESULTS (2026-02-27):
# Test URL: https://dbis.ur.de/UBTIB/browse/subjects/9/
# - Database entries: a[href*='/resources/'] → 80 found ✓
# - Database names: a[href*='/resources/'] → 80 found ✓
# - Traffic lights: img.traffic-light → 32 found ✓
# - Traffic lights (alt): img[src*='ampel'] → 32 found ✓
# Screenshot: /tmp/dbis_final.png
